require "rubygems"
require "serialport"
require 'weather_man'
require "date"
require "time"

WeatherMan.partner_id = '1108475457'
WeatherMan.license_key = 'c2ceac28a53c1dba'
$red = 3
$blue = 4
$device_list = [1]
class Send
  def print1
    puts 1
  end
  
  def initialize(port)
    #params for serial port
    @port_str = "/dev/ttyUSB0"  #may be different for you
    @baud_rate = 9600
    @data_bits = 8
    @stop_bits = 1
    @parity = SerialPort::NONE
    @next_check = Time.now + (60 * 60)
    puts Time.now
    puts @next_check
  end

 
  def weather(devicenum)
    # Search for a location
    # Returns an array of WeatherMan objects
    # or if you know the location id or just want to use a US Zip code
    ny = WeatherMan.new('12180')
    weather = ny.fetch(:day => 0)
    description = weather.forecast.today.day.description
    puts description
    case description
    when /sun/i
      action = 15
    when /cloud/i
      action = 75
    when /shower/i
      action = 60
    when /few.+showers/i
      action = 40
    when /storm/i
      action = 100
    else
      action = 50
    end
    puts action
    action = (action * 2.55)
    puts action
    serial_send(devicenum)
    serial_send($red)
    serial_send(action)
    serial_send(devicenum)
    serial_send($blue)
    serial_send(action)
    @next_check = Time.now + (60 * 60)
  end

  def time_check()
    $device_list.each do |x| weather(x); end if Time.now<=>@next_check >= 0
  end

  def serial_send (input)
    SerialPort.open(@port_str, @baud_rate, @data_bits, @stop_bits, @parity) {|sp|
      sp.putc input.to_i(16)
    }
    puts input
  end
end

Shoes.app :width => 600, :height => 300 do
	send = Send.new("/dev/ttyUSB0")
	send.print1
	flow :width => 1.0 do
		stack  :width => 1.0, :height => 75 do
			title "Free Space Hydroponics"
		end
    stack :width => 0.5, :height => 225 do
      para "\n\nSlave Reactor Number:\n",
        "Device to alter:\n",
        "Value:", :size => 14
    end
		stack :width => 0.5, :height => 425 do
      para "\n"
			@s = edit_line :width => 200
      @d = edit_line :width => 200
      @v = edit_line :width => 200
      button("Send to device") do
        send.serial_send(@s.text)
        send.serial_send(@d.text)
        send.serial_send(@v.text)
			end
      			
    end		
   
  end
end
